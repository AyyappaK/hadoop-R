#!/usr/bin/env Rscript

con = file("stdin", open = "r")
delays <- numeric(0)
lastKey <- ""
while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0) {
  split <- unlist(strsplit(line, "\t"))
  key <- split[[1]]
  fields <- unlist(strsplit(split[[2]], "\\,"))
  deptDelay <- fields[[16]]
  if (!(identical(deptDelay, "NA"))) {
    deptDelay <- as.numeric(deptDelay)
  } else {
    deptDelay <- 0
  }

  if (!(identical(lastKey, "")) & (!(identical(lastKey, key)))) {
    keySplit = unlist(strsplit(lastKey, "\\|"))
    cat(keySplit[[2]], "\t", keySplit[[3]], "\t", length(delays), "\t", keySplit[[1]], "\t", (mean(delays)), "\n")
    lastKey <- key
    delays <- c(deptDelay)
  } else {
      lastKey <- key
      delays <- c(delays, deptDelay)
  }
}

keySplit = unlist(strsplit(lastKey, "\\|"))
cat(keySplit[[2]], "\t", keySplit[[3]], "\t", length(delays), "\t", keySplit[[1]], "\t", (mean(delays)), "\n")

